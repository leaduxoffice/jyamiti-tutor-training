<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Jyamiti Tutor System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-gray-800 shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-500 rounded-lg"></div>
                    <h1 class="text-2xl font-bold">Jyamiti <span class="text-blue-400">Admin</span></h1>
                </div>
                <nav class="flex space-x-6">
                    <a href="/admin" class="font-semibold text-blue-400">Dashboard</a>
                    <a href="/admin/selected.html" class="hover:text-blue-400">Selected</a>
                    <a href="/admin/interview.html" class="hover:text-blue-400">Interview</a>
                </nav>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <!-- Statistics Cards -->
        <div id="stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Stats will be loaded here -->
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="glass p-6 rounded-xl">
                <h3 class="text-lg font-semibold mb-4">Applications by Status</h3>
                <div id="statusChart"></div>
            </div>
            <div class="glass p-6 rounded-xl">
                <h3 class="text-lg font-semibold mb-4">Experience Distribution</h3>
                <div id="experienceChart"></div>
            </div>
        </div>

        <!-- Filters and Table -->
        <div class="glass p-6 rounded-xl">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 space-y-4 md:space-y-0">
                <h2 class="text-xl font-bold">All Applications</h2>
                <div class="flex space-x-4">
                    <input type="text" id="searchInput" placeholder="Search by name, email..." 
                           class="px-4 py-2 bg-gray-800 rounded-lg border border-gray-700 focus:outline-none focus:border-blue-500">
                    <select id="statusFilter" class="px-4 py-2 bg-gray-800 rounded-lg border border-gray-700">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="selected">Selected</option>
                        <option value="rejected">Rejected</option>
                        <option value="interview_selected">Interview Selected</option>
                    </select>
                </div>
            </div>

            <!-- Filter Controls -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-800/50 rounded-lg">
                <div>
                    <label class="block text-sm mb-1">Age Range</label>
                    <div class="flex space-x-2">
                        <input type="number" id="minAge" placeholder="Min" class="w-full px-3 py-1 bg-gray-700 rounded border border-gray-600">
                        <input type="number" id="maxAge" placeholder="Max" class="w-full px-3 py-1 bg-gray-700 rounded border border-gray-600">
                    </div>
                </div>
                <div>
                    <label class="block text-sm mb-1">Experience (Years)</label>
                    <div class="flex space-x-2">
                        <input type="number" id="minExp" placeholder="Min" class="w-full px-3 py-1 bg-gray-700 rounded border border-gray-600">
                        <input type="number" id="maxExp" placeholder="Max" class="w-full px-3 py-1 bg-gray-700 rounded border border-gray-600">
                    </div>
                </div>
                <div>
                    <label class="block text-sm mb-1">Gender</label>
                    <select id="genderFilter" class="w-full px-3 py-1 bg-gray-700 rounded border border-gray-600">
                        <option value="">All</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="loadApplications()" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium">
                        Apply Filters
                    </button>
                </div>
            </div>

            <!-- Applications Table -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-gray-700">
                            <th class="py-3 px-4 text-left">Name</th>
                            <th class="py-3 px-4 text-left">Email</th>
                            <th class="py-3 px-4 text-left">Age</th>
                            <th class="py-3 px-4 text-left">Experience</th>
                            <th class="py-3 px-4 text-left">Qualification</th>
                            <th class="py-3 px-4 text-left">Status</th>
                            <th class="py-3 px-4 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="applicationsTable">
                        <!-- Applications will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="pagination" class="flex justify-between items-center mt-6 pt-6 border-t border-gray-700">
                <!-- Pagination will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div id="statusModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Update Status</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white">âœ•</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm mb-2">Select Status</label>
                    <select id="statusSelect" class="w-full px-4 py-2 bg-gray-700 rounded-lg">
                        <option value="pending">Pending</option>
                        <option value="selected">Selected for Training</option>
                        <option value="rejected">Rejected</option>
                        <option value="interview_selected">Selected for Interview</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm mb-2">Reason/Notes</label>
                    <textarea id="statusNotes" rows="3" class="w-full px-4 py-2 bg-gray-700 rounded-lg"></textarea>
                </div>
                <div id="interviewDateField" class="hidden">
                    <label class="block text-sm mb-2">Interview Date</label>
                    <input type="datetime-local" id="interviewDate" class="w-full px-4 py-2 bg-gray-700 rounded-lg">
                </div>
                <button onclick="updateStatus()" class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold">
                    Update Status
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentApplicationId = null;
        let currentPage = 1;
        const limit = 20;

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch('/api/applications/stats');
                const data = await response.json();
                
                if (data.success) {
                    displayStats(data.data);
                    createCharts(data.data);
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function displayStats(stats) {
            const statsContainer = document.getElementById('stats');
            
            const statCards = [
                { 
                    title: 'Total Applications', 
                    value: stats.total[0]?.count || 0,
                    icon: 'ðŸ“‹',
                    color: 'from-blue-500 to-blue-600'
                },
                { 
                    title: 'Selected for Training', 
                    value: stats.byStatus.find(s => s._id === 'selected')?.count || 0,
                    icon: 'âœ…',
                    color: 'from-green-500 to-green-600'
                },
                { 
                    title: 'Interview Selected', 
                    value: stats.byStatus.find(s => s._id === 'interview_selected')?.count || 0,
                    icon: 'ðŸ“…',
                    color: 'from-purple-500 to-purple-600'
                },
                { 
                    title: 'Avg Experience', 
                    value: (stats.byExperience.reduce((acc, curr) => acc + curr.avgAge * curr.count, 0) / stats.total[0]?.count || 0).toFixed(1) + ' yrs',
                    icon: 'ðŸ“Š',
                    color: 'from-orange-500 to-orange-600'
                }
            ];

            statsContainer.innerHTML = statCards.map(card => `
                <div class="stat-card p-6 rounded-xl text-white">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm opacity-90">${card.title}</p>
                            <p class="text-3xl font-bold mt-2">${card.value}</p>
                        </div>
                        <span class="text-3xl">${card.icon}</span>
                    </div>
                </div>
            `).join('');
        }

        function createCharts(stats) {
            // Status Chart
            const statusData = stats.byStatus.map(s => ({
                x: s._id,
                y: s.count
            }));

            const statusChart = new ApexCharts(document.querySelector("#statusChart"), {
                series: [{
                    data: statusData
                }],
                chart: {
                    type: 'bar',
                    height: 300,
                    foreColor: '#9CA3AF'
                },
                xaxis: {
                    categories: statusData.map(d => d.x)
                },
                colors: ['#3B82F6'],
                plotOptions: {
                    bar: {
                        borderRadius: 4,
                        columnWidth: '60%',
                    }
                }
            });
            statusChart.render();

            // Experience Chart
            const expLabels = stats.byExperience.map(e => `${e._id}+ years`);
            const expData = stats.byExperience.map(e => e.count);

            const expChart = new ApexCharts(document.querySelector("#experienceChart"), {
                series: expData,
                chart: {
                    type: 'donut',
                    height: 300
                },
                labels: expLabels,
                colors: ['#3B82F6', '#10B981', '#8B5CF6', '#F59E0B', '#EF4444'],
                legend: {
                    position: 'bottom'
                }
            });
            expChart.render();
        }

        // Load applications with filters
        async function loadApplications(page = 1) {
            try {
                const params = new URLSearchParams({
                    page: page,
                    limit: limit,
                    status: document.getElementById('statusFilter').value,
                    minAge: document.getElementById('minAge').value,
                    maxAge: document.getElementById('maxAge').value,
                    minExperience: document.getElementById('minExp').value,
                    maxExperience: document.getElementById('maxExp').value,
                    gender: document.getElementById('genderFilter').value,
                    search: document.getElementById('searchInput').value
                });

                const response = await fetch(`/api/applications?${params}`);
                const data = await response.json();

                if (data.success) {
                    displayApplications(data.data);
                    displayPagination(data.pagination);
                    currentPage = page;
                }
            } catch (error) {
                console.error('Error loading applications:', error);
            }
        }

        function displayApplications(applications) {
            const table = document.getElementById('applicationsTable');
            
            if (applications.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="7" class="py-8 text-center text-gray-500">
                            No applications found
                        </td>
                    </tr>
                `;
                return;
            }

            table.innerHTML = applications.map(app => `
                <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                    <td class="py-3 px-4">${app.name}</td>
                    <td class="py-3 px-4">${app.email}</td>
                    <td class="py-3 px-4">${app.age}</td>
                    <td class="py-3 px-4">${app.experience} yrs</td>
                    <td class="py-3 px-4">${app.qualification}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 rounded-full text-xs font-medium
                            ${app.status === 'selected' ? 'bg-green-900/30 text-green-400' : 
                              app.status === 'rejected' ? 'bg-red-900/30 text-red-400' :
                              app.status === 'interview_selected' ? 'bg-purple-900/30 text-purple-400' :
                              'bg-yellow-900/30 text-yellow-400'}">
                            ${app.status.replace('_', ' ')}
                        </span>
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex space-x-2">
                            <button onclick="openStatusModal('${app._id}')" 
                                    class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm">
                                Update
                            </button>
                            <button onclick="viewDetails('${app._id}')" 
                                    class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm">
                                View
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function displayPagination(pagination) {
            const paginationDiv = document.getElementById('pagination');
            const totalPages = pagination.pages;
            
            let paginationHTML = `
                <div class="text-sm text-gray-400">
                    Showing ${(currentPage - 1) * limit + 1} to 
                    ${Math.min(currentPage * limit, pagination.total)} of 
                    ${pagination.total} entries
                </div>
                <div class="flex space-x-2">
            `;
            
            if (currentPage > 1) {
                paginationHTML += `
                    <button onclick="loadApplications(${currentPage - 1})" 
                            class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded">
                        Previous
                    </button>
                `;
            }
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `
                        <button onclick="loadApplications(${i})" 
                                class="px-3 py-1 rounded ${currentPage === i ? 
                                    'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'}">
                            ${i}
                        </button>
                    `;
                }
            }
            
            if (currentPage < totalPages) {
                paginationHTML += `
                    <button onclick="loadApplications(${currentPage + 1})" 
                            class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded">
                        Next
                    </button>
                `;
            }
            
            paginationHTML += '</div>';
            paginationDiv.innerHTML = paginationHTML;
        }

        // Modal functions
        function openStatusModal(applicationId) {
            currentApplicationId = applicationId;
            document.getElementById('statusModal').classList.remove('hidden');
            document.getElementById('statusModal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('statusModal').classList.add('hidden');
            document.getElementById('statusModal').classList.remove('flex');
            document.getElementById('interviewDateField').classList.add('hidden');
        }

        function showInterviewDate() {
            const status = document.getElementById('statusSelect').value;
            const interviewField = document.getElementById('interviewDateField');
            
            if (status === 'interview_selected') {
                interviewField.classList.remove('hidden');
            } else {
                interviewField.classList.add('hidden');
            }
        }

        async function updateStatus() {
            try {
                const status = document.getElementById('statusSelect').value;
                const notes = document.getElementById('statusNotes').value;
                const interviewDate = document.getElementById('interviewDate').value;
                
                const updateData = {
                    status: status,
                    eligibility_reason: notes
                };
                
                if (interviewDate) {
                    updateData.interview_date = interviewDate;
                }

                const response = await fetch(`/api/applications/${currentApplicationId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('Status updated successfully!');
                    closeModal();
                    loadApplications(currentPage);
                    loadStats();
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Error updating status');
            }
        }

        function viewDetails(applicationId) {
            window.open(`/admin/detail.html?id=${applicationId}`, '_blank');
        }

        // Event listeners
        document.getElementById('statusSelect').addEventListener('change', showInterviewDate);
        document.getElementById('searchInput').addEventListener('input', 
            debounce(() => loadApplications(1), 500));
        document.getElementById('statusFilter').addEventListener('change', 
            () => loadApplications(1));

        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize
        loadStats();
        loadApplications();
    </script>
</body>
</html>